<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatApp</title>
    <style>
        :root {
            --bg-color: #1e1e2e;
            --sidebar-color: #181825;
            --text-color: #cdd6f4;
            --accent-color: #5c6bc0;
            --hover-color: #313244;
            --success-color: #a6e3a1;
            --error-color: #f38ba8;
            --input-bg: #313244;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Scrollbar Styles */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--sidebar-color);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--hover-color);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-color);
        }

        /* Auth Screen */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: var(--bg-color);
        }

        .auth-form {
            background-color: var(--sidebar-color);
            padding: 2rem;
            border-radius: 20px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .auth-form h2 {
            margin-bottom: 1.5rem;
            text-align: center;
            color: var(--accent-color);
        }

        .auth-form input {
            width: 100%;
            padding: 0.75rem;
            margin-bottom: 1rem;
            border: none;
            border-radius: 10px;
            background-color: var(--input-bg);
            color: var(--text-color);
        }

        .auth-form button {
            width: 100%;
            padding: 0.75rem;
            background-color: var(--accent-color);
            color: var(--sidebar-color);
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            margin-bottom: 1rem;
        }

        .auth-form button:hover {
            opacity: 0.9;
        }

        .auth-switch {
            text-align: center;
            color: var(--accent-color);
            cursor: pointer;
            margin-top: 1rem;
        }

        .error-message {
            color: var(--error-color);
            margin-bottom: 1rem;
            text-align: center;
        }

        /* Main App */
        .app-container {
            display: none;
            height: 100vh;
            overflow: hidden;
        }

        .app-header {
            background-color: var(--sidebar-color);
            padding: 1rem;
            text-align: center;
            font-weight: bold;
            border-bottom: 1px solid var(--hover-color);
        }

        .app-content {
            display: flex;
            height: calc(100vh - 60px);
        }

        .sidebar {
            width: 250px;
            background-color: var(--sidebar-color);
            border-right: 1px solid var(--hover-color);
            padding: 1rem;
            overflow-y: auto;
        }

        .sidebar-item {
            padding: 0.75rem;
            border-radius: 15px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
        }

        .sidebar-item:hover {
            background-color: var(--hover-color);
        }

        .sidebar-item.active {
            background-color: var(--accent-color);
            color: var(--sidebar-color);
        }

        .sidebar-item i {
            margin-right: 0.5rem;
        }

        .main-content {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
        }

        /* Profile Tab */
        .profile-info {
            max-width: 600px;
            margin: 0 auto;
        }

        .profile-info h2 {
            margin-bottom: 1rem;
            color: var(--accent-color);
        }

        .profile-field {
            margin-bottom: 1rem;
        }

        .profile-field label {
            display: block;
            margin-bottom: 0.25rem;
            color: var(--accent-color);
        }

        .profile-field input {
            width: 100%;
            padding: 0.5rem;
            background-color: var(--input-bg);
            border: none;
            border-radius: 10px;
            color: var(--text-color);
        }

        .copy-container {
            display: flex;
        }

        .copy-btn {
            margin-left: 0.5rem;
            background-color: var(--accent-color);
            color: var(--sidebar-color);
            border: none;
            border-radius: 10px;
            padding: 0.5rem;
            cursor: pointer;
            font-size: 1rem;
        }

        /* Friends Tab */
        .friends-search {
            margin-bottom: 1rem;
        }

        .friends-search input {
            width: 100%;
            padding: 0.5rem;
            background-color: var(--input-bg);
            border: none;
            border-radius: 10px;
            color: var(--text-color);
            margin-bottom: 0.5rem;
        }

        .friends-search button {
            padding: 0.5rem 1rem;
            background-color: var(--accent-color);
            color: var(--sidebar-color);
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin-right: 0.5rem;
        }

        .friends-list {
            margin-top: 1rem;
        }

        .friend-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background-color: var(--input-bg);
            border-radius: 15px;
            margin-bottom: 0.5rem;
        }

        .friend-actions button {
            margin-left: 0.5rem;
            padding: 0.25rem 0.5rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
        }

        .friend-actions .chat-btn {
            background-color: var(--accent-color);
            color: var(--sidebar-color);
        }

        .friend-actions .remove-btn {
            background-color: var(--error-color);
            color: white;
        }

        /* Search Results */
        .search-result {
            background-color: var(--input-bg);
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .search-result-info {
            display: flex;
            align-items: center;
        }

        .search-result-actions button {
            padding: 0.5rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            background-color: var(--accent-color);
            color: var(--sidebar-color);
        }

        /* Notifications Tab */
        .notification-item {
            padding: 0.75rem;
            background-color: var(--input-bg);
            border-radius: 15px;
            margin-bottom: 0.5rem;
        }

        .notification-message {
            margin-bottom: 0.5rem;
        }

        .notification-actions button {
            margin-right: 0.5rem;
            padding: 0.25rem 0.5rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
        }

        .notification-actions .accept-btn {
            background-color: var(--success-color);
            color: var(--sidebar-color);
        }

        .notification-actions .block-btn {
            background-color: var(--error-color);
            color: white;
        }

        .notification-actions .dismiss-btn {
            background-color: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--text-color);
        }

        /* Chat Tab */
        .chat-container {
            display: flex;
            height: calc(100vh - 120px);
        }

        .chat-friends {
            width: 250px;
            border-right: 1px solid var(--hover-color);
            overflow-y: auto;
            padding-right: 1rem;
        }

        .chat-messages {
            flex: 1;
            padding: 0 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .chat-friend-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border-radius: 15px;
            margin-bottom: 0.5rem;
            cursor: pointer;
        }

        .chat-friend-item:hover {
            background-color: var(--hover-color);
        }

        .chat-friend-item.active {
            background-color: var(--accent-color);
            color: var(--sidebar-color);
        }

        .chat-friend-actions button {
            margin-left: 0.5rem;
            padding: 0.25rem 0.5rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .chat-friend-actions .block-btn {
            background-color: var(--error-color);
            color: white;
        }

        .chat-friend-actions .delete-chat-btn {
            background-color: var(--hover-color);
            color: var(--text-color);
        }

        .message {
            max-width: 70%;
            padding: 0.75rem;
            border-radius: 20px;
            margin-bottom: 0.75rem;
            word-wrap: break-word;
        }

        .message-outgoing {
            align-self: flex-end;
            background-color: var(--accent-color);
            color: var(--sidebar-color);
        }

        .message-incoming {
            align-self: flex-start;
            background-color: var(--input-bg);
        }

        .timestamp {
            display: block;
            font-size: 0.7em;
            text-align: right;
            margin-top: 0.5em;
            opacity: 0.7;
        }

        .date-separator {
            text-align: center;
            margin: 1rem 0;
            color: var(--hover-color);
            font-size: 0.8em;
        }

        .chat-input {
            display: flex;
            margin-top: auto;
            padding: 1rem 0;
        }

        .chat-input input {
            flex: 1;
            padding: 0.75rem;
            background-color: var(--input-bg);
            border: none;
            border-radius: 10px;
            color: var(--text-color);
            margin-right: 0.5rem;
        }

        .chat-input button {
            padding: 0.75rem 1.5rem;
            background-color: var(--accent-color);
            color: var(--sidebar-color);
            border: none;
            border-radius: 10px;
            cursor: pointer;
        }

        /* Status Dots */
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 0.5rem;
        }

        .online {
            background-color: green;
        }

        .offline {
            background-color: red;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 1rem 2rem;
            border-radius: 10px;
            color: white;
            z-index: 1000;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }

        .toast.success {
            background-color: var(--success-color);
            color: var(--sidebar-color);
        }

        .toast.error {
            background-color: var(--error-color);
        }

        @keyframes fadein {
            from { bottom: 0; opacity: 0; }
            to { bottom: 20px; opacity: 1; }
        }

        @keyframes fadeout {
            from { bottom: 20px; opacity: 1; }
            to { bottom: 0; opacity: 0; }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .app-content {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
                border-right: none;
                border-bottom: 1px solid var(--hover-color);
            }

            .chat-container {
                flex-direction: column;
                height: auto;
            }

            .chat-friends {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid var(--hover-color);
                margin-bottom: 1rem;
                padding-bottom: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Auth Screen -->
    <div class="auth-container" id="auth-container">
        <div class="auth-form">
            <h2 id="auth-title">Login</h2>
            <div class="error-message" id="error-message"></div>
            <input type="text" id="username" placeholder="Username">
            <input type="password" id="password" placeholder="Password">
            <button id="auth-button">Login</button>
            <div class="auth-switch" id="auth-switch">Don't have an account? Register</div>
        </div>
    </div>

    <!-- Main App -->
    <div class="app-container" id="app-container">
        <div class="app-header">
            ChatApp
        </div>
        <div class="app-content">
            <div class="sidebar">
                <div class="sidebar-item" data-tab="profile">
                    <i>👤</i> Profile
                </div>
                <div class="sidebar-item" data-tab="chat">
                    <i>💬</i> Chat
                </div>
                <div class="sidebar-item" data-tab="friends">
                    <i>👥</i> Friends
                </div>
                <div class="sidebar-item" data-tab="notifications">
                    <i>🔔</i> Notifications
                </div>
                <div class="sidebar-item" id="logout-button">
                    <i>🚪</i> Logout
                </div>
            </div>
            <div class="main-content" id="main-content">
                <!-- Content will be loaded here based on tab selection -->
            </div>
        </div>
    </div>

    <script>
        // Data structure for users
        const usersDB = 'chatAppUsers';
        const currentUserKey = 'chatAppCurrentUser';
        const userIdIndexDB = 'chatAppUserIdIndex'; // New storage for ID to username mapping
        
        // BroadcastChannel for multi-tab sync
        const broadcastChannel = new BroadcastChannel('chatAppUpdates');

        // Generate a 20-digit unique ID
        function generateId() {
            return Array.from({length: 20}, () => Math.floor(Math.random() * 10)).join('');
        }

        // Get all users from localStorage
        function getAllUsers() {
            const users = localStorage.getItem(usersDB);
            return users ? JSON.parse(users) : {};
        }

        // Get ID to username mapping
        function getUserIdIndex() {
            const index = localStorage.getItem(userIdIndexDB);
            return index ? JSON.parse(index) : {};
        }

        // Save all users to localStorage
        function saveAllUsers(users) {
            localStorage.setItem(usersDB, JSON.stringify(users));
            
            // Update the ID index
            const index = {};
            for (const username in users) {
                index[users[username].id] = username;
            }
            localStorage.setItem(userIdIndexDB, JSON.stringify(index));
            
            broadcastChannel.postMessage({type: 'dataUpdate'});
        }

        // Get current user from localStorage
        function getCurrentUser() {
            const username = localStorage.getItem(currentUserKey);
            if (!username) return null;
            
            const users = getAllUsers();
            return users[username] || null;
        }

        // Set current user in localStorage
        function setCurrentUser(username) {
            localStorage.setItem(currentUserKey, username);
        }

        // Clear current user (logout)
        function clearCurrentUser() {
            localStorage.removeItem(currentUserKey);
        }

        // Update last active
        function updateLastActive() {
            const currentUser = getCurrentUser();
            if (!currentUser) return;
            
            const users = getAllUsers();
            currentUser.lastActive = Date.now();
            users[currentUser.username] = currentUser;
            saveAllUsers(users);
        }

        // Find user by ID
        function findUserById(userId) {
            const index = getUserIdIndex();
            const username = index[userId];
            if (!username) return null;
            
            const users = getAllUsers();
            return users[username] || null;
        }

        // Time ago function
        function timeAgo(timestamp) {
            if (!timestamp) return 'never';
            const seconds = Math.floor((Date.now() - timestamp) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " years ago";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " months ago";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + " days ago";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " hours ago";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + " minutes ago";
            return "just now";
        }

        // Register a new user
        function register(username, password) {
            const users = getAllUsers();
            
            if (users[username]) {
                return {success: false, message: 'Username already exists'};
            }
            
            const userId = generateId();
            users[username] = {
                username,
                password,
                id: userId,
                friends: [],
                blocked: [],
                chats: {},
                notifications: [],
                lastActive: Date.now()
            };
            
            saveAllUsers(users);
            return {success: true};
        }

        // Login a user
        function login(username, password) {
            const users = getAllUsers();
            const user = users[username];
            
            if (!user) {
                return {success: false, message: 'User not found'};
            }
            
            if (user.password !== password) {
                return {success: false, message: 'Incorrect password'};
            }
            
            user.lastActive = Date.now();
            users[username] = user;
            saveAllUsers(users);
            setCurrentUser(username);
            return {success: true};
        }

        // Send a friend request
        function sendFriendRequest(receiverId) {
            const currentUser = getCurrentUser();
            if (!currentUser) return {success: false, message: 'Not logged in'};
            
            const receiver = findUserById(receiverId);
            
            if (!receiver) {
                return {success: false, message: 'User not found'};
            }
            
            if (receiver.username === currentUser.username) {
                return {success: false, message: 'Cannot add yourself'};
            }
            
            if (currentUser.friends.includes(receiver.username)) {
                return {success: false, message: 'Already friends'};
            }
            
            if (currentUser.blocked.includes(receiver.username)) {
                return {success: false, message: 'User is blocked'};
            }
            
            // Check if request already exists
            const existingRequest = receiver.notifications.find(
                n => n.type === 'friendRequest' && n.from === currentUser.username
            );
            
            if (existingRequest) {
                return {success: false, message: 'Request already sent'};
            }
            
            // Add notification to receiver
            const users = getAllUsers();
            receiver.notifications.push({
                type: 'friendRequest',
                from: currentUser.username
            });
            
            users[receiver.username] = receiver;
            saveAllUsers(users);
            updateLastActive();
            
            return {success: true};
        }

        // Handle friend request response
        function handleFriendRequest(fromUsername, action) {
            const currentUser = getCurrentUser();
            if (!currentUser) return {success: false, message: 'Not logged in'};
            
            const users = getAllUsers();
            const sender = users[fromUsername];
            
            if (!sender) {
                return {success: false, message: 'User not found'};
            }
            
            // Remove the notification
            currentUser.notifications = currentUser.notifications.filter(
                n => !(n.type === 'friendRequest' && n.from === fromUsername)
            );
            
            if (action === 'accept') {
                if (currentUser.blocked.includes(fromUsername)) {
                    return {success: false, message: 'Cannot accept blocked user'};
                }
                // Add each other as friends if not already
                if (!currentUser.friends.includes(fromUsername)) {
                    currentUser.friends.push(fromUsername);
                }
                
                if (!sender.friends.includes(currentUser.username)) {
                    sender.friends.push(currentUser.username);
                }
                
                // Initialize chat if it doesn't exist
                if (!currentUser.chats[fromUsername]) {
                    currentUser.chats[fromUsername] = [];
                }
                
                if (!sender.chats[currentUser.username]) {
                    sender.chats[currentUser.username] = [];
                }
            } else if (action === 'block') {
                if (!currentUser.blocked.includes(fromUsername)) {
                    currentUser.blocked.push(fromUsername);
                }
            }
            // For dismiss, just remove notification
            
            // Update both users
            users[currentUser.username] = currentUser;
            users[fromUsername] = sender;
            saveAllUsers(users);
            updateLastActive();
            
            return {success: true};
        }

        // Send a message to a friend
        function sendMessage(friendUsername, messageText) {
            const currentUser = getCurrentUser();
            if (!currentUser) return {success: false, message: 'Not logged in'};
            
            const users = getAllUsers();
            const friend = users[friendUsername];
            
            if (!friend) {
                return {success: false, message: 'Friend not found'};
            }
            
            if (!currentUser.friends.includes(friendUsername)) {
                return {success: false, message: 'Not friends'};
            }
            
            if (currentUser.blocked.includes(friendUsername)) {
                return {success: false, message: 'User is blocked'};
            }
            
            // Add message to current user's chat
            if (!currentUser.chats[friendUsername]) {
                currentUser.chats[friendUsername] = [];
            }
            
            currentUser.chats[friendUsername].push({
                from: currentUser.username,
                text: messageText,
                timestamp: new Date().toISOString()
            });
            
            // Add message to friend's chat
            if (!friend.chats[currentUser.username]) {
                friend.chats[currentUser.username] = [];
            }
            
            friend.chats[currentUser.username].push({
                from: currentUser.username,
                text: messageText,
                timestamp: new Date().toISOString()
            });
            
            // Update both users
            users[currentUser.username] = currentUser;
            users[friendUsername] = friend;
            saveAllUsers(users);
            updateLastActive();
            
            return {success: true};
        }

        // Block a user
        function blockUser(friendUsername) {
            const currentUser = getCurrentUser();
            if (!currentUser) return;
            
            const users = getAllUsers();
            const friend = users[friendUsername];
            
            if (!friend) return;
            
            if (!currentUser.blocked.includes(friendUsername)) {
                currentUser.blocked.push(friendUsername);
            }
            
            // Remove from friends
            currentUser.friends = currentUser.friends.filter(f => f !== friendUsername);
            friend.friends = friend.friends.filter(f => f !== currentUser.username);
            
            users[currentUser.username] = currentUser;
            users[friendUsername] = friend;
            saveAllUsers(users);
            updateLastActive();
        }

        // Delete chat
        function deleteChat(friendUsername) {
            const currentUser = getCurrentUser();
            if (!currentUser) return;
            
            const users = getAllUsers();
            const friend = users[friendUsername];
            
            if (!friend) return;
            
            currentUser.chats[friendUsername] = [];
            friend.chats[currentUser.username] = [];
            
            users[currentUser.username] = currentUser;
            users[friendUsername] = friend;
            saveAllUsers(users);
            updateLastActive();
        }

        // Show toast
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.classList.add('toast', type);
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // UI Functions
        function showAuthScreen() {
            document.getElementById('auth-container').style.display = 'flex';
            document.getElementById('app-container').style.display = 'none';
            clearCurrentUser();
        }

        function showAppScreen() {
            document.getElementById('auth-container').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';
            loadTab('profile');
        }

        function loadTab(tabName) {
            const mainContent = document.getElementById('main-content');
            const currentUser = getCurrentUser();
            
            if (!currentUser) {
                showAuthScreen();
                return;
            }
            
            updateLastActive();
            
            // Update active tab in sidebar
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.tab === tabName) {
                    item.classList.add('active');
                }
            });
            
            const users = getAllUsers();
            
            switch (tabName) {
                case 'profile':
                    mainContent.innerHTML = `
                        <div class="profile-info">
                            <h2>Profile</h2>
                            <div class="profile-field">
                                <label>Username</label>
                                <input type="text" value="${currentUser.username}" readonly>
                            </div>
                            <div class="profile-field">
                                <label>User ID</label>
                                <div class="copy-container">
                                    <input type="text" value="${currentUser.id}" readonly>
                                    <button class="copy-btn" data-copy="${currentUser.id}">📋</button>
                                </div>
                            </div>
                        </div>
                    `;
                    document.querySelectorAll('.copy-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            navigator.clipboard.writeText(btn.dataset.copy);
                            showToast('Copied to clipboard!');
                        });
                    });
                    break;
                    
                case 'friends':
                    mainContent.innerHTML = `
                        <div class="friends-search">
                            <h2>Friends</h2>
                            <input type="text" id="friend-id-input" placeholder="Enter friend's ID">
                            <button id="search-user-button">Search User</button>
                            <div id="search-results" style="margin-top: 1rem;"></div>
                        </div>
                        <div class="friends-list" id="friends-list">
                            ${currentUser.friends.map(friend => {
                                const friendUser = users[friend] || {};
                                const diff = Date.now() - (friendUser.lastActive || 0);
                                const isOnline = diff < 300000; // 5 minutes
                                const statusTitle = isOnline ? 'Online' : `Last seen ${timeAgo(friendUser.lastActive)}`;
                                return `
                                    <div class="friend-item">
                                        <span title="${statusTitle}">
                                            <span class="status-dot ${isOnline ? 'online' : 'offline'}"></span>
                                            ${friend}
                                        </span>
                                        <div class="friend-actions">
                                            <button class="chat-btn" data-friend="${friend}">Chat</button>
                                            <button class="remove-btn" data-friend="${friend}">Remove</button>
                                        </div>
                                    </div>
                                `;
                            }).join('') || '<p>No friends yet. Add some!</p>'}
                        </div>
                    `;
                    
                    document.getElementById('search-user-button').addEventListener('click', () => {
                        const friendId = document.getElementById('friend-id-input').value.trim();
                        if (!friendId) {
                            showToast('Please enter a user ID', 'error');
                            return;
                        }
                        
                        const user = findUserById(friendId);
                        const resultsDiv = document.getElementById('search-results');
                        
                        if (user) {
                            const isFriend = currentUser.friends.includes(user.username);
                            const isBlocked = currentUser.blocked.includes(user.username);
                            const isSelf = user.username === currentUser.username;
                            
                            let status = '';
                            if (isFriend) status = ' (Already friends)';
                            else if (isBlocked) status = ' (Blocked)';
                            else if (isSelf) status = ' (You)';
                            
                            resultsDiv.innerHTML = `
                                <div class="search-result">
                                    <div class="search-result-info">
                                        <span class="status-dot ${user.lastActive && (Date.now() - user.lastActive < 300000) ? 'online' : 'offline'}"></span>
                                        <span>Found user: <strong>${user.username}</strong>${status}</span>
                                    </div>
                                    ${!isFriend && !isBlocked && !isSelf ? 
                                        '<button class="search-result-actions" id="send-request-button">Send Friend Request</button>' : ''}
                                </div>
                            `;
                            
                            if (!isFriend && !isBlocked && !isSelf) {
                                document.getElementById('send-request-button').addEventListener('click', () => {
                                    const result = sendFriendRequest(user.id);
                                    if (result.success) {
                                        showToast('Friend request sent!');
                                        resultsDiv.innerHTML = '';
                                        document.getElementById('friend-id-input').value = '';
                                    } else {
                                        showToast(result.message, 'error');
                                    }
                                });
                            }
                        } else {
                            resultsDiv.innerHTML = '<div class="search-result">User not found</div>';
                        }
                    });
                    
                    document.querySelectorAll('.friend-actions .chat-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const friend = e.target.dataset.friend;
                            loadChat(friend);
                        });
                    });
                    
                    document.querySelectorAll('.friend-actions .remove-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const friend = e.target.dataset.friend;
                            removeFriend(friend);
                        });
                    });
                    break;
                    
                case 'notifications':
                    mainContent.innerHTML = `
                        <h2>Notifications</h2>
                        <div id="notifications-list">
                            ${currentUser.notifications.map(notification => {
                                if (notification.type === 'friendRequest') {
                                    return `
                                        <div class="notification-item">
                                            <div class="notification-message">
                                                ${notification.from} wants to be your friend
                                            </div>
                                            <div class="notification-actions">
                                                <button class="accept-btn" data-from="${notification.from}">Accept</button>
                                                <button class="block-btn" data-from="${notification.from}">Block</button>
                                                <button class="dismiss-btn" data-from="${notification.from}">Dismiss</button>
                                            </div>
                                        </div>
                                    `;
                                }
                                return '';
                            }).join('') || '<p>No notifications</p>'}
                        </div>
                    `;
                    
                    document.querySelectorAll('.accept-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const from = e.target.dataset.from;
                            const result = handleFriendRequest(from, 'accept');
                            if (result.success) {
                                showToast('Friend request accepted!');
                            } else {
                                showToast(result.message, 'error');
                            }
                            loadTab('notifications');
                        });
                    });
                    
                    document.querySelectorAll('.block-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const from = e.target.dataset.from;
                            handleFriendRequest(from, 'block');
                            showToast('User blocked');
                            loadTab('notifications');
                        });
                    });
                    
                    document.querySelectorAll('.dismiss-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const from = e.target.dataset.from;
                            handleFriendRequest(from, 'dismiss');
                            loadTab('notifications');
                        });
                    });
                    break;
                    
                case 'chat':
                    mainContent.innerHTML = `
                        <div class="chat-container">
                            <div class="chat-friends" id="chat-friends">
                                ${currentUser.friends.map(friend => {
                                    const friendUser = users[friend] || {};
                                    const diff = Date.now() - (friendUser.lastActive || 0);
                                    const isOnline = diff < 300000;
                                    const statusTitle = isOnline ? 'Online' : `Last seen ${timeAgo(friendUser.lastActive)}`;
                                    return `
                                        <div class="chat-friend-item" data-friend="${friend}">
                                            <span title="${statusTitle}">
                                                <span class="status-dot ${isOnline ? 'online' : 'offline'}"></span>
                                                ${friend}
                                            </span>
                                            <div class="chat-friend-actions">
                                                <button class="block-btn" data-friend="${friend}">Block</button>
                                                <button class="delete-chat-btn" data-friend="${friend}">Delete Chat</button>
                                            </div>
                                        </div>
                                    `;
                                }).join('') || '<p>No friends to chat with</p>'}
                            </div>
                            <div class="chat-messages" id="chat-messages">
                                <p>Select a friend to start chatting</p>
                            </div>
                        </div>
                        <div class="chat-input" id="chat-input" style="display: none;">
                            <input type="text" id="message-input" placeholder="Type a message...">
                            <button id="send-message-button">Send</button>
                        </div>
                    `;
                    
                    document.querySelectorAll('.chat-friend-item[data-friend]').forEach(item => {
                        item.addEventListener('click', (e) => {
                            if (e.target.tagName === 'BUTTON') return;
                            const friend = item.dataset.friend;
                            loadChat(friend);
                        });
                    });

                    document.querySelectorAll('.block-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const friend = e.target.dataset.friend;
                            blockUser(friend);
                            showToast('User blocked');
                            loadTab('chat');
                        });
                    });

                    document.querySelectorAll('.delete-chat-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const friend = e.target.dataset.friend;
                            deleteChat(friend);
                            showToast('Chat deleted');
                            loadTab('chat');
                        });
                    });
                    break;
            }
        }

        function loadChat(friendUsername) {
            const currentUser = getCurrentUser();
            if (!currentUser) return;
            
            const chatMessages = document.getElementById('chat-messages');
            const chatInput = document.getElementById('chat-input');
            
            if (!chatMessages || !chatInput) {
                loadTab('chat');
                setTimeout(() => loadChat(friendUsername), 100);
                return;
            }
            
            updateLastActive();
            
            // Update active friend in list
            document.querySelectorAll('.chat-friend-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.friend === friendUsername) {
                    item.classList.add('active');
                }
            });
            
            // Display messages with date separators and timestamps
            const messages = currentUser.chats[friendUsername] || [];
            let prevDate = null;
            let html = '';
            messages.forEach(msg => {
                const msgDate = new Date(msg.timestamp).toDateString();
                if (msgDate !== prevDate) {
                    html += `<div class="date-separator">${new Date(msg.timestamp).toLocaleDateString()}</div>`;
                    prevDate = msgDate;
                }
                const isOutgoing = msg.from === currentUser.username;
                const timeStr = new Date(msg.timestamp).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
                html += `
                    <div class="message ${isOutgoing ? 'message-outgoing' : 'message-incoming'}">
                        ${msg.text}
                        <small class="timestamp">${timeStr}</small>
                    </div>
                `;
            });
            chatMessages.innerHTML = html;
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Show input and set up event listener
            chatInput.style.display = 'flex';
            const messageInput = document.getElementById('message-input');
            const sendButton = document.getElementById('send-message-button');
            
            // Clear existing event listeners
            const newSendButton = sendButton.cloneNode(true);
            sendButton.parentNode.replaceChild(newSendButton, sendButton);
            
            newSendButton.addEventListener('click', () => {
                const messageText = messageInput.value.trim();
                if (messageText) {
                    const result = sendMessage(friendUsername, messageText);
                    if (result.success) {
                        messageInput.value = '';
                        loadChat(friendUsername);
                    } else {
                        showToast(result.message, 'error');
                    }
                }
            });
            
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const messageText = messageInput.value.trim();
                    if (messageText) {
                        const result = sendMessage(friendUsername, messageText);
                        if (result.success) {
                            messageInput.value = '';
                            loadChat(friendUsername);
                        } else {
                            showToast(result.message, 'error');
                        }
                    }
                }
            });
            
            // Focus input
            messageInput.focus();
        }

        function removeFriend(friendUsername) {
            const currentUser = getCurrentUser();
            if (!currentUser) return;
            
            const users = getAllUsers();
            const friend = users[friendUsername];
            
            if (!friend) return;
            
            // Remove from current user's friends
            currentUser.friends = currentUser.friends.filter(f => f !== friendUsername);
            
            // Remove from friend's friends
            if (friend.friends) {
                friend.friends = friend.friends.filter(f => f !== currentUser.username);
            }
            
            // Update both users
            users[currentUser.username] = currentUser;
            users[friendUsername] = friend;
            saveAllUsers(users);
            updateLastActive();
            
            // Reload friends tab
            loadTab('friends');
        }

        // Initialize the app
        function initApp() {
            // Check if user is logged in
            const currentUser = getCurrentUser();
            if (currentUser) {
                updateLastActive();
                showAppScreen();
                setInterval(updateLastActive, 60000);
            } else {
                showAuthScreen();
            }
            
            // Auth screen setup
            const authTitle = document.getElementById('auth-title');
            const authButton = document.getElementById('auth-button');
            const authSwitch = document.getElementById('auth-switch');
            const errorMessage = document.getElementById('error-message');
            
            let isLogin = true;
            
            function updateAuthUI() {
                if (isLogin) {
                    authTitle.textContent = 'Login';
                    authButton.textContent = 'Login';
                    authSwitch.textContent = 'Don\'t have an account? Register';
                } else {
                    authTitle.textContent = 'Register';
                    authButton.textContent = 'Register';
                    authSwitch.textContent = 'Already have an account? Login';
                }
                errorMessage.textContent = '';
            }
            
            authSwitch.addEventListener('click', () => {
                isLogin = !isLogin;
                updateAuthUI();
            });
            
            authButton.addEventListener('click', () => {
                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value.trim();
                
                if (!username || !password) {
                    errorMessage.textContent = 'Please enter both username and password';
                    return;
                }
                
                if (isLogin) {
                    const result = login(username, password);
                    if (result.success) {
                        setInterval(updateLastActive, 60000);
                        showAppScreen();
                    } else {
                        errorMessage.textContent = result.message;
                    }
                } else {
                    const result = register(username, password);
                    if (result.success) {
                        errorMessage.textContent = 'Registration successful! Please login.';
                        isLogin = true;
                        updateAuthUI();
                    } else {
                        errorMessage.textContent = result.message;
                    }
                }
            });
            
            // App setup
            document.querySelectorAll('.sidebar-item[data-tab]').forEach(item => {
                item.addEventListener('click', () => {
                    const tabName = item.dataset.tab;
                    loadTab(tabName);
                });
            });
            
            document.getElementById('logout-button').addEventListener('click', () => {
                clearCurrentUser();
                showAuthScreen();
            });
            
            // Handle tab changes from URL hash
            window.addEventListener('hashchange', () => {
                const tabName = window.location.hash.substring(1);
                if (tabName) {
                    loadTab(tabName);
                }
            });
            
            // Listen for data updates from other tabs
            broadcastChannel.addEventListener('message', (event) => {
                if (event.data.type === 'dataUpdate') {
                    // Reload current tab to reflect changes
                    const currentTab = document.querySelector('.sidebar-item.active')?.dataset.tab;
                    if (currentTab) {
                        loadTab(currentTab);
                    }
                }
            });
            
            // Initial tab load
            if (currentUser) {
                const initialTab = window.location.hash.substring(1) || 'profile';
                loadTab(initialTab);
            }
            
            updateAuthUI();
        }

        // Start the app
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
